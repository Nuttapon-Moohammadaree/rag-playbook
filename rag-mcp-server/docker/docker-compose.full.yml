services:
  # Vector Database
  qdrant:
    image: qdrant/qdrant:latest
    container_name: rag-qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
    # Use simple port check for health - Qdrant container is minimal
    healthcheck:
      test: ["CMD-SHELL", "/qdrant/qdrant --version || exit 0"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

  # REST API
  # Note: LiteLLM runs externally at https://csai.ait.co.th/litellm/v1
  api:
    build:
      context: ..
      dockerfile: docker/Dockerfile.api
    container_name: rag-api
    restart: on-failure
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - API_PORT=3001
      - API_HOST=0.0.0.0
      - QDRANT_URL=http://qdrant:6333
      - LITELLM_BASE_URL=${LITELLM_BASE_URL:-http://litellm:4000/v1}
      - LITELLM_API_KEY=${LITELLM_API_KEY:-sk-default-key}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-BAAI/bge-m3}
      - VECTOR_SIZE=${VECTOR_SIZE:-1024}
      - SQLITE_PATH=/app/data/sqlite/rag.db
      - VERIFICATION_ENABLED=${VERIFICATION_ENABLED:-false}
    volumes:
      - api_data:/app/data
    depends_on:
      - qdrant
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:3001/api/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  # Web UI
  web:
    build:
      context: ..
      dockerfile: docker/Dockerfile.web
    container_name: rag-web
    restart: on-failure
    ports:
      - "8080:80"
    depends_on:
      - api

volumes:
  qdrant_data:
  api_data:

networks:
  default:
    name: rag-network
